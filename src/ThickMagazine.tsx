/*
Auto-generated by: https://github.com/pmndrs/gltfjsx
*/

import * as THREE from "three";
import React, { useEffect, useRef, useState } from "react";
import { useGLTF, useAnimations, useTexture } from "@react-three/drei";
import { GLTF } from "three-stdlib";
import { ThreeEvent, useFrame, useThree } from "@react-three/fiber";
import { clamp } from "three/src/math/MathUtils.js";

type GLTFResult = GLTF & {
  nodes: {
    Plane002: THREE.Mesh;
    Plane002_1: THREE.Mesh;
    Plane005: THREE.Mesh;
    Plane005_1: THREE.Mesh;
    Plane006: THREE.Mesh;
    Plane006_1: THREE.Mesh;
  };
  materials: {
    Material: THREE.MeshStandardMaterial;
    ["Material.001"]: THREE.MeshStandardMaterial;

  };
};

type ActionName = "Scene";
type GLTFActions = Record<ActionName, THREE.AnimationAction>;

export default function ThickMagazine(props: JSX.IntrinsicElements["group"]) {
  const minPage = 0;
  const maxPage = 2;
  const [page, setPage] = useState(0);
  const checkerTexture = useTexture("checker.png")
  checkerTexture.wrapS = THREE.RepeatWrapping
  checkerTexture.wrapT = THREE.RepeatWrapping
  checkerTexture.magFilter = THREE.NearestFilter;
  checkerTexture.colorSpace = THREE.SRGBColorSpace;
  const repeats = 4;
  checkerTexture.repeat.set(repeats, repeats);
  const cyclePage = (direction: number) => {
    const newPageNum = clamp(page + direction, minPage, maxPage);
    setPage(newPageNum);
  };

  const group = useRef<THREE.Group>();
  const FRAMES_PER_SEC = 24;
  const PAGE_FLIP_FRAMES = 32;
  const actionRef = useRef<THREE.AnimationAction>();
  const keyframeRef = useRef(0);
  const { nodes, materials, animations } = useGLTF(
    "/ThickMagazine.glb",
  ) as GLTFResult;
  const { actions } = useAnimations(animations, group);
  const calcFrame = (pg: number) => {
    return (PAGE_FLIP_FRAMES * pg) / FRAMES_PER_SEC;
  };

  useEffect(() => {
    actions.Scene?.setLoop(THREE.LoopOnce, 1);
    actions.Scene?.play();

    actionRef!.current = actions.Scene ?? undefined;
  }, [actions.Scene]);

  useEffect(() => {
    keyframeRef.current = calcFrame(page);
  }, [page]);

  useFrame(() => {
    if (actionRef.current) {
      const diff = actionRef.current.time - keyframeRef.current;
      if (Math.abs(diff) < 0.1) {
        actionRef.current.timeScale = 0;
      } else if (diff > 0) {
        actionRef.current.timeScale = -1;
      } else {
        actionRef.current.timeScale = 1;
      }
    }
  });


  return (
    <group ref={group} {...props} dispose={null}>
      <group name="Scene">
        <group name="Sheet1" position={[0, 0.02, 0]}>
          <mesh
            name="Page1"
            castShadow
            receiveShadow
            geometry={nodes.Plane002.geometry}
            material={new THREE.MeshStandardMaterial({ map: checkerTexture })}
            morphTargetDictionary={nodes.Plane002.morphTargetDictionary}
            morphTargetInfluences={nodes.Plane002.morphTargetInfluences}
          />
          <mesh
            name="Page2"
            castShadow
            receiveShadow
            geometry={nodes.Plane002_1.geometry}
            material={materials["Material.001"]}
            morphTargetDictionary={nodes.Plane002_1.morphTargetDictionary}
            morphTargetInfluences={nodes.Plane002_1.morphTargetInfluences}
          />
        </group>
        <group name="Sheet2" position={[0, 0.01, 0]}>
          <mesh
            name="Page3"
            castShadow
            receiveShadow
            geometry={nodes.Plane005.geometry}
            material={materials.Material}
            morphTargetDictionary={nodes.Plane005.morphTargetDictionary}
            morphTargetInfluences={nodes.Plane005.morphTargetInfluences}
          />
          <mesh
            name="Page4"
            castShadow
            receiveShadow
            geometry={nodes.Plane005_1.geometry}
            material={materials["Material.001"]}
            morphTargetDictionary={nodes.Plane005_1.morphTargetDictionary}
            morphTargetInfluences={nodes.Plane005_1.morphTargetInfluences}
          />
        </group>
        <group name="Sheet3">
          <mesh
            name="Page5"
            castShadow
            receiveShadow
            geometry={nodes.Plane006.geometry}
            material={materials.Material}
            morphTargetDictionary={nodes.Plane006.morphTargetDictionary}
            morphTargetInfluences={nodes.Plane006.morphTargetInfluences}
          />
          <mesh
            name="Page6"
            castShadow
            receiveShadow
            geometry={nodes.Plane006_1.geometry}
            material={materials["Material.001"]}
            morphTargetDictionary={nodes.Plane006_1.morphTargetDictionary}
            morphTargetInfluences={nodes.Plane006_1.morphTargetInfluences}
          />
        </group>
      </group>
    </group>
  );
}

useGLTF.preload("/ThickMagazine.glb");
